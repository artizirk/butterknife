#!/usr/bin/python3
import os

from optparse import OptionParser
parser = OptionParser()
parser.add_option("-p", "--pool", default="/mnt/pool", help="Btrfs pool path, defaults to /mnt/pool")
parser.add_option("-n", "--name", help="Name of the container to prepare")
parser.add_option("-c", "--comment", help="Comment for snapshot")
options, args = parser.parse_args()

if not os.path.ismount(options.pool):
    print("Pool path", options.pool, "is not mountpoint")
    exit(255)

POOL_TEMPLATES = os.path.join(options.pool, "templates")

if not os.path.exists(POOL_TEMPLATES):
    os.makedirs(POOL_TEMPLATES)

if not options.name:
    print("No container name specified!")
    exit(255)

import lxc
container=lxc.Container(options.name)
if container.running:
    print("Stopping container")
    container.stop()


ROOTFS = container.get_config_item("lxc.rootfs")

if not os.path.isdir(os.path.join(ROOTFS, "etc", "butterknife")):
    print("The container is not prepared for Butterknife, /etc/butterknife is missing!")
    exit(253)

assert os.path.isdir(ROOTFS), "No directory at %s" % ROOTFS

POSTDEPLOY_SCRIPTS = os.path.join(ROOTFS, "etc", "butterknife", "postdeploy.d")
assert os.path.isdir(POSTDEPLOY_SCRIPTS), "Postinstall scripts directory %s missing!" % POSTINSTALL_SCRIPTS

snapshot = container.snapshot()
print("Created snapshot:", snapshot)

SNAPSHOT_DIRECTORY = os.path.join("/var/lib/lxcsnaps", options.name, snapshot)

BUTTERKNIFE_CONFIG = os.path.join(SNAPSHOT_DIRECTORY, "etc", "butterknife")

with open(os.path.join(BUTTERKNIFE_CONFIG, "issue"), "w") as fh:
    fh.write("TEMPLATE=\"%s\"\n" % options.name)
    fh.write("SNAPSHOT=\"%s\"\n" % snapshot)
    
# TODO: Run pre-release scripts here


TEMPLATE_DIRECTORY = os.path.join(TEMPLATE_POOL, str(uuid.uuid4()))


cmd = "btrfs", "subvolume", "snapshot", "-r", os.path.join(SNAPSHOT_DIRECTORY, "rootfs"), TEMPLATE_DIRECTORY
print("Executing:", " ".join(cmd))

import subprocess
subprocess.call(cmd)

