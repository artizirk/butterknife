#!/usr/bin/python3
import os

if not os.path.exists("/mnt/pool"):
    print("Creating /mnt/pool")
    os.makedirs("/mnt/pool")

if not os.path.ismount("/mnt/pool"):
    print("Mounting /dev/sda1 at /mnt/pool")
    os.system("mount /dev/sda1 /mnt/pool")

from optparse import OptionParser
parser = OptionParser()
parser.add_option("-p", "--pool", default="/mnt/pool", help="Btrfs pool path, defaults to /mnt/pool")
parser.add_option("-n", "--name", help="Name of the container to prepare")
parser.add_option("-c", "--comment", help="Comment for snapshot")
options, args = parser.parse_args()

if not options.name:
    print("No container name specified!")
    exit(255)

import lxc
container=lxc.Container(options.name)
if container.running:
    print("Stopping container")
    container.stop()

print(dir(container))
print(container.get_keys())

ROOTFS = container.get_config_item("lxc.rootfs")

assert os.path.isdir(ROOTFS), "No directory at %s" % ROOTFS

POSTDEPLOY_SCRIPTS = os.path.join(ROOTFS, "etc", "butterknife", "postdeploy.d")
assert os.path.isdir(POSTDEPLOY_SCRIPTS), "Postinstall scripts directory %s missing!" % POSTINSTALL_SCRIPTS

snapshot = container.snapshot()
print("Created snapshot:", snapshot)

snapdir = os.path.join("/var/lib/lxcsnaps", options.name, snapshot)

# TODO: Run pre-release scripts here

cmd = "btrfs", "subvolume", "snapshot", "-r", os.path.join(snapdir, "rootfs"), os.path.join(snapdir, "rootfs-ro")
print("Executing:", " ".join(cmd))

import subprocess
subprocess.call(cmd)

